<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø­Ø§Ø³Ø¨Ø© Ù„ÙÙ…Ù‰ Ø¹ØµØ§Ù… Ø§Ù„Ø·ÙˆÙŠÙ„</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0ea5e9" />
<style>
:root{
  --bg:#0b1220;--card:#0e1729;--muted:#94a3b8;--text:#e5e7eb;
  --border:#1f2a3c;--primary:#0ea5e9;--primary2:#0284c7;--ok:#22c55e;--warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Tajawal,Segoe UI,Arial}
.wrap{min-height:100dvh;display:grid;place-items:center;padding:16px}
.card{width:min(720px,96vw);background:var(--card);border:1px solid var(--border);
      border-radius:18px;padding:18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
h1{margin:6px 0 14px;text-align:center;color:#c7f9ff;font-size:24px}
.grid{display:grid;gap:12px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
label{font-size:13px;color:var(--muted)}
input,select,textarea{
  width:100%;padding:12px 10px;border-radius:12px;border:1px solid #213044;
  background:#0a1324;color:var(--text);outline:none
}
textarea{min-height:66px;resize:vertical}
input::placeholder{color:#6b7d95}
.btn{padding:12px 14px;border:none;border-radius:12px;background:var(--primary);color:#001a29;
     font-weight:700;cursor:pointer}
.btn:hover{background:var(--primary2);color:white}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.note{font-size:12px;color:var(--muted)}
.box{margin-top:12px;background:#091223;border:1px solid #1a2639;border-radius:12px;padding:12px}
.box h3{margin:0 0 10px;color:#a7f3d0;font-size:16px}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.pill{background:#0d1a2c;border:1px solid #24314a;border-radius:10px;text-align:center;padding:10px;font-size:13px}
.small{font-size:12px;color:var(--muted)}
.range{display:grid;grid-template-columns:1fr 1fr;gap:8px}
footer{margin-top:10px;text-align:center;font-size:12px;color:#6b7d95}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ’‰ Ø­Ø§Ø³Ø¨Ø© Ù„ÙÙ…Ù‰ Ø¹ØµØ§Ù… Ø§Ù„Ø·ÙˆÙŠÙ„</h1>

    <div class="grid">
      <div class="row3">
        <div>
          <label>Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ø­Ø§Ù„ÙŠ (mg/dL)</label>
          <input id="current" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 240">
        </div>
        <div>
          <label>Ø§Ù„Ù‡Ø¯Ù (mg/dL)</label>
          <input id="target" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 120-130" value="130">
        </div>
        <div>
          <label>ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
          <select id="round">
            <option value="0.5">0.5</option>
            <option value="1">1.0</option>
            <option value="0.1" selected>0.1</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª (ØºØ±Ø§Ù…) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
          <input id="carb" type="number" inputmode="decimal" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù„ØªØµØ­ÙŠØ­ ÙÙ‚Ø·">
        </div>
        <div>
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª ICR</label>
          <input id="icr" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 12">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ ISF</label>
          <input id="isf" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 95" value="95">
        </div>
        <div>
          <label>Ø­Ø¯ Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¬Ø±Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="maxDose" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 10">
        </div>
        <div>
          <label>Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªÙ†Ø¨Ø¤ (1h/2h/3h)</label>
          <input id="factors" type="text" placeholder="0.40,0.75,0.95" value="0.40,0.75,0.95">
        </div>
      </div>

      <div class="btns">
        <button class="btn" onclick="calc()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
        <button class="btn" style="background:#334155;color:#e5e7eb" onclick="resetAll()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>

      <div class="note">Ù„Ùˆ ØªØ±ÙƒØª Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª ÙØ§Ø±ØºØ© ÙØ³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ <b>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ ÙÙ‚Ø·</b> + ØªÙ†Ø¨Ø¤ Ø¨Ø¹Ø¯ 1 / 2 / 3 Ø³Ø§Ø¹Ø§Øª.</div>

      <div id="out" class="box" style="display:none"></div>

      <div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¬Ø±Ø¹Ø§Øª/Ø§Ù„ÙˆØ¬Ø¨Ø§Øª"></textarea>
      </div>
    </div>

    <footer>ÙŠØ­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² â€” Ø·ÙˆÙ‘ÙØ± Ø®ØµÙŠØµÙ‹Ø§ Ù„Ù„ÙÙ…Ù‰ â¤ï¸</footer>
  </div>
</div>

<script>
// ---------- helpers & persistence ----------
const IDs = ["current","target","carb","icr","isf","maxDose","factors","round","notes"];
const defaults = { target:130, isf:95, round:"0.1", factors:"0.40,0.75,0.95" };
const el = id => document.getElementById(id);
const num = v => { const x = parseFloat(v); return isNaN(x) ? null : x; };
const clamp = (x,min,max) => Math.max(min, Math.min(max, x));

IDs.forEach(id=>{
  const node = el(id);
  const saved = localStorage.getItem("lama_"+id);
  node.value = saved ?? (defaults[id] ?? "");
  node.addEventListener("change",()=>localStorage.setItem("lama_"+id, node.value));
});

function roundTo(x, step){
  const s = parseFloat(step || "0.1");
  return Math.round(x / s) * s;
}

function parseFactors(s){
  try{
    const parts = (s || "0.40,0.75,0.95").split(",").map(t=>parseFloat(t.trim()));
    const arr = parts.filter(v => !isNaN(v) && v>=0 && v<=1);
    return arr.length===3 ? arr : [0.40,0.75,0.95];
  }catch(_){ return [0.40,0.75,0.95]; }
}

// ---------- main calculation ----------
function calc(){
  const current = num(el("current").value);
  const target  = num(el("target").value);
  const carb    = num(el("carb").value);
  const icr     = num(el("icr").value);
  const isf     = num(el("isf").value);
  const maxDose = num(el("maxDose").value);
  const rstep   = el("round").value;
  const factors = parseFactors(el("factors").value);

  if(current===null || target===null || isf===null){
    alert("Ø£Ø¯Ø®Ù„: Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø§Ù„Ù‡Ø¯ÙØŒ ÙˆÙ…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ (ISF). Ø§Ù„Ø¨Ù‚ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©.");
    return;
  }

  // meal units (optional)
  let meal=0;
  if(carb!==null && carb>0){
    if(icr===null || icr<=0){ alert("Ø£Ø¯Ø®Ù„ ICR Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©ØŒ Ø£Ùˆ Ø§ØªØ±Ùƒ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª ÙØ§Ø±ØºØ©."); return; }
    meal = carb / icr;
  }

  // correction units (non-negative)
  let corr = (current - target) / isf;
  corr = Math.max(0, corr);

  let total = meal + corr;
  total = roundTo(total, rstep);

  if(maxDose!==null && maxDose>0) total = Math.min(total, maxDose);

  // predictions: fraction of correction effect realized
  const preds = factors.map(frac => Math.round(target + (current - target)*(1 - frac)));

  const out = el("out");
  out.style.display = "block";
  out.innerHTML = `
    <h3>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
    <div class="kpis">
      <div class="pill">ØªØµØ­ÙŠØ­: <b>${roundTo(corr, rstep).toFixed(2)}</b> ÙˆØ­Ø¯Ø©</div>
      <div class="pill">ÙˆØ¬Ø¨Ø©: <b>${roundTo(meal, rstep).toFixed(2)}</b> ÙˆØ­Ø¯Ø©</div>
      <div class="pill" style="border-color:#2563eb">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${total.toFixed(2)}</b> ÙˆØ­Ø¯Ø©</div>
    </div>
    <div class="kpis" style="margin-top:10px">
      <div class="pill">Ø¨Ø¹Ø¯ 1 Ø³Ø§Ø¹Ø© â‰ˆ <b>${preds[0]}</b> mg/dL</div>
      <div class="pill">Ø¨Ø¹Ø¯ 2 Ø³Ø§Ø¹ØªÙŠÙ† â‰ˆ <b>${preds[1]}</b> mg/dL</div>
      <div class="pill">Ø¨Ø¹Ø¯ 3 Ø³Ø§Ø¹Ø§Øª â‰ˆ <b>${preds[2]}</b> mg/dL</div>
    </div>
    <div class="small" style="margin-top:10px">
      * ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¹Ù„Ù‰ ISFØŒ Ù…Ø¹ Ø§ÙØªØ±Ø§Ø¶ ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø«Ø± ${Math.round(factors[0]*100)}% / ${Math.round(factors[1]*100)}% / ${Math.round(factors[2]*100)}% Ø®Ù„Ø§Ù„ 1/2/3 Ø³Ø§Ø¹Ø§Øª.
    </div>
  `;
}

function resetAll(){
  IDs.forEach(id=>{ localStorage.removeItem("lama_"+id); });
  location.reload();
}
</script>
</body>
</html>
